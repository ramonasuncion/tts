openapi: 3.0.3
info:
  title: TTS API
  description: "OpenAPI spec for the TTS"
  version: 1.0.0
servers:
  - url: http://localhost:8000/api
    description: Local development server (adjust host/port as needed)
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    TTSRequest:
      type: object
      properties:
        text:
          type: string
          description: Text to synthesize. Moderation and alias parsing may be applied.
        voice:
          type: string
          description: Alias or voice id. If missing, server picks default voice.
        preset:
          type: string
          description: Preset name (e.g., fast, high_quality)
        length_scale:
          type: number
          format: float
          default: 1.0
        noise_w:
          type: number
          format: float
        sentence_silence:
          type: number
          format: float
        speaker_id:
          type: integer
        format:
          type: string
          enum: [mp3, wav]
        normalize:
          type: boolean
          default: true
        bitrate:
          type: string
      required:
        - text
    TTSBatchPart:
      type: object
      properties:
        text:
          type: string
        voice:
          type: string
        sfx:
          type: string
      additionalProperties: false
    TTSBatchRequest:
      type: object
      properties:
        parts:
          type: array
          items:
            $ref: "#/components/schemas/TTSBatchPart"
        format:
          type: string
          enum: [mp3, wav]
        preset:
          type: string
        length_scale:
          type: number
          format: float
        noise_w:
          type: number
          format: float
        sentence_silence:
          type: number
        normalize:
          type: boolean
        bitrate:
          type: string
      required:
        - parts
    AliasRequest:
      type: object
      properties:
        name:
          type: string
        voice:
          type: string
      required: [name, voice]
    SfxAliasRequest:
      type: object
      properties:
        name:
          type: string
        target:
          type: string
      required: [name, target]
    AuthRequest:
      type: object
      properties:
        role:
          type: string
        key:
          type: string
      required: [role, key]
    AuthResponse:
      type: object
      properties:
        role:
          type: string
        key:
          type: string
    PushRequest:
      type: object
      properties:
        text:
          type: string
        voice:
          type: string
        id:
          type: string
      required: [text]
    PushResponse:
      type: object
      properties:
        ok:
          type: boolean
        id:
          type: string
        queued:
          type: integer
    ModMaskRequest:
      type: object
      properties:
        text:
          type: string
      required: [text]
    ModMaskResponse:
      type: object
      properties:
        masked:
          type: string
        flags:
          type: object
  responses:
    BinaryAudio:
      description: Binary audio response (mp3 or wav)
      content:
        audio/mpeg:
          schema:
            type: string
            format: binary
        audio/wav:
          schema:
            type: string
            format: binary
      headers:
        X-Req-Id:
          description: Request id
          schema:
            type: string
        X-Voice:
          description: Final voice id used
          schema:
            type: string
        X-Voice-Requested:
          description: Voice requested by caller
          schema:
            type: string
        X-Voice-Fallback:
          description: 0 or 1 when fallback used
          schema:
            type: integer
        X-Cache:
          description: hit or miss
          schema:
            type: string
        X-Text-Chars:
          description: Number of chars in text
          schema:
            type: integer
        X-Bytes:
          description: Response bytes
          schema:
            type: integer
        X-Duration-MS:
          description: Synth duration in milliseconds
          schema:
            type: integer
paths:
  /voices:
    get:
      summary: List detected voices
      tags: [voices]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Array of available voices
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
  /sounds:
    get:
      summary: List available SFX (index and aliases)
      tags: [sfx]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: SFX index and aliases
          content:
            application/json:
              schema:
                type: object
                properties:
                  index:
                    type: object
                    description: Map or list describing available SFX files
                  aliases:
                    type: object
                    additionalProperties:
                      type: string
  /aliases:
    get:
      summary: Get voice aliases
      tags: [aliases]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Map of aliases to voice ids
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: string
    post:
      summary: Create or update an alias
      tags: [aliases]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AliasRequest"
      responses:
        "200":
          description: Alias created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
  /aliases/{name}:
    delete:
      summary: Delete an alias
      tags: [aliases]
      security:
        - ApiKeyAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Alias deleted
  /sfx_aliases:
    post:
      summary: Add SFX alias
      tags: [sfx]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SfxAliasRequest"
      responses:
        "200":
          description: SFX alias created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
  /sfx_aliases/{name}:
    delete:
      summary: Delete an SFX alias
      tags: [sfx]
      security:
        - ApiKeyAuth: []
      parameters:
        - in: path
          name: name
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted and returning current aliases
          content:
            application/json:
              schema:
                type: object
                properties:
                  aliases:
                    type: object
                    additionalProperties:
                      type: string
  /tts:
    post:
      summary: Synthesize text to audio
      tags: [tts]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TTSRequest"
            examples:
              simple:
                value:
                  text: "obiwan: hello there"
                  format: mp3
      responses:
        "200":
          $ref: "#/components/responses/BinaryAudio"
        "400":
          description: Invalid input (e.g., text collapsed to empty after moderation)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    get:
      summary: Synthesize text via query params (convenience GET)
      tags: [tts]
      security:
        - ApiKeyAuth: []
      parameters:
        - in: query
          name: text
          schema:
            type: string
          required: true
        - in: query
          name: voice
          schema:
            type: string
        - in: query
          name: format
          schema:
            type: string
            enum: [mp3, wav]
        - in: query
          name: preset
          schema:
            type: string
        - in: query
          name: length_scale
          schema:
            type: number
            format: float
        - in: query
          name: noise_scale
          schema:
            type: number
            format: float
        - in: query
          name: noise_w
          schema:
            type: number
            format: float
        - in: query
          name: sentence_silence
          schema:
            type: number
            format: float
        - in: query
          name: normalize
          schema:
            type: boolean
        - in: query
          name: bitrate
          schema:
            type: string
        - in: query
          name: speaker_id
          schema:
            type: integer
      responses:
        "200":
          $ref: "#/components/responses/BinaryAudio"
  /tts_batch:
    post:
      summary: Batch render dialog + SFX and return concatenated audio
      tags: [tts]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TTSBatchRequest"
            examples:
              dialog:
                value:
                  parts:
                    - text: "ready?"
                      voice: nina
                    - sfx: airhorn
                    - text: "go!"
                      voice: trump
                  format: mp3
                  preset: fast
      responses:
        "200":
          $ref: "#/components/responses/BinaryAudio"
  /panel/login:
    post:
      summary: Create a session (panel login)
      tags: [panel]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRequest"
      responses:
        "200":
          description: Returns role and key and sets a session cookie
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
  /panel/logout:
    post:
      summary: Clear session
      tags: [panel]
      responses:
        "204":
          description: Logged out
  /panel/status:
    get:
      summary: Check session role flags
      tags: [panel]
      responses:
        "200":
          description: JSON object with role booleans
          content:
            application/json:
              schema:
                type: object
                properties:
                  admin:
                    type: boolean
                  mod:
                    type: boolean
                  tts:
                    type: boolean
                  push:
                    type: boolean
                  pull:
                    type: boolean
  /mod/mask:
    post:
      summary: Apply moderation masking to text
      tags: [moderation]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ModMaskRequest"
      responses:
        "200":
          description: Masked text and flags
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModMaskResponse"
  /mod/list:
    get:
      summary: Get blocked terms (moderation list)
      tags: [moderation]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Array of blocked terms
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
  /mod/add:
    post:
      summary: Add blocked term
      tags: [moderation]
      security:
        - ApiKeyAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                term:
                  type: string
              required:
                - term
      responses:
        "200":
          description: "{ added: true }"
  /mod/remove:
    post:
      summary: Remove blocked term
      tags: [moderation]
      security:
        - ApiKeyAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                term:
                  type: string
              required:
                - term
      responses:
        "200":
          description: "{ removed: true }"
  /mod/reload:
    post:
      summary: Reload moderation list
      tags: [moderation]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Reloaded
  /mod/test:
    get:
      summary: Test moderation filter on text
      tags: [moderation]
      parameters:
        - in: query
          name: text
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Filtered result and flags
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModMaskResponse"
  /push:
    post:
      summary: Queue a TTS item
      tags: [queue]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PushRequest"
      responses:
        "200":
          description: Queued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PushResponse"
  /pull:
    get:
      summary: Pop next queued item
      tags: [queue]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Next queued item
          content:
            application/json:
              schema:
                type: object
        "204":
          description: Queue empty
  /peek:
    get:
      summary: Peek head item without removing
      tags: [queue]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Head item
          content:
            application/json:
              schema:
                type: object
        "204":
          description: Queue empty
  /queue/{id}:
    delete:
      summary: Delete matching items from queue
      tags: [queue]
      security:
        - ApiKeyAuth: []
      parameters:
        - in: path
          name: qid
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deletion result
  /reload:
    post:
      summary: Rescan voices
      tags: [voices]
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Returns count of discovered voices
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
  /healthz:
    get:
      summary: Health check
      tags: [health]
      responses:
        "200":
          description: OK
  /metrics:
    get:
      summary: Metrics for cache and voices
      tags: [metrics]
      responses:
        "200":
          description: Prometheus-style metrics or JSON depending on server
          content:
            text/plain:
              schema:
                type: string
tags:
  - name: tts
  - name: panel
  - name: voices
  - name: aliases
  - name: sfx
  - name: moderation
  - name: queue
  - name: health
  - name: metrics
